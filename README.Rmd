---
title: "cocktailr"
output:
  github_document:
    toc: true
    toc_depth: 3
    df_print: default
editor_options:
  chunk_output_type: console
---

```{r, include=FALSE}
# Global knitr options for fast, reproducible README builds
knitr::opts_chunk$set(
  collapse   = TRUE,
  comment    = "#>",
  fig.path   = "man/figures/README-",
  fig.width  = 7,
  fig.height = 5,
  dpi        = 150,
  out.width  = "100%",
  warning    = FALSE,
  message    = FALSE,
  cache      = FALSE
)
set.seed(1)
```

# cocktailr

Fast, reproducible *Cocktail* clustering for vegetation tables.

---

## Overview

**cocktailr** provides fast and reproducible *Cocktail* clustering of vegetation data, identifying groups of co-occurring species from **plots × species** tables. It uses optimized sparse-matrix calculations and φ (phi) coefficients to produce consistent, deterministic results, even for large vegetation databases.

The package implements:

- **Hierarchical Cocktail clustering** of species (`cocktail_cluster()`).
- **Dendrogram plotting** with φ heights and optional cluster bands (`cocktail_plot()`).
- Extraction of **parent clusters at a φ cut** (`clusters_at_cut()`).
- **Diagnostic species lists** for clusters or unions of clusters (`species_in_clusters()`).
- **φ-based distances between clusters** (`cluster_phi_dist()`).
- **Assignment of plots (relevés) to groups** using several strategies that combine covers, topology, and species–cluster φ (`assign_releves()`).

---

## Background

The *Cocktail* method (Bruelheide 2000, 2016) identifies sets of species that co-occur more often than expected by chance and merges them hierarchically according to the **phi coefficient of association**. Each resulting cluster is characterized by its diagnostic species and a threshold (*m*) indicating how many group species a plot must contain to belong to it.

For details, see the original works:

- Bruelheide, H. (2000). *A new measure of fidelity and its application to defining species groups.* **Journal of Vegetation Science**, 11, 167–178. <https://doi.org/10.2307/3236796>  
- Bruelheide, H. (2016). *Cocktail clustering – a new hierarchical agglomerative algorithm for extracting species groups in vegetation databases.* **Journal of Vegetation Science**, 27(6), 1297–1307. <https://doi.org/10.1111/jvs.12454>

---

## Installation

```r
# Install from GitHub
remotes::install_github("dvynokur/cocktailr")
```

---

## Typical workflow

A small end-to-end example on a toy **plots × species** matrix, showing:

1. Cocktail clustering with optional species–cluster φ.
2. Dendrogram plotting.
3. Selecting clusters at a φ cut.
4. Diagnostic species lists.
5. φ-based distances between clusters and grouping.
6. Plot assignment using φ and cover, optionally with grouped nodes.

```{r typical-workflow}
library(cocktailr)

# Toy plots × species matrix with percentage cover
vm <- matrix(
  c(
    60,50,40,30,  5, 0,10, 0,
    55,45,35,25, 10, 5, 0, 0,
    50,40,30,20,  5,10, 0, 5,
    45,35,25,15,  0, 5, 5, 0,
    10, 5, 0, 0, 60,50,40,30,
     5,10, 0, 0, 55,45,35,25,
     0, 5,10, 0, 50,40,30,20,
     0, 0, 5,10, 45,35,25,15
  ),
  nrow = 8, byrow = TRUE,
  dimnames = list(
    paste0("plot", 1:8),
    paste0("sp",   1:8)
  )
)

# 1) Cocktail clustering, keeping relative cover and species–cluster phi
res <- cocktail_cluster(
  vegmatrix           = vm,
  progress            = FALSE,
  plot_values         = "rel_cover",   # keeps cover-based Plot.cluster
  species_cluster_phi = TRUE           # computes Species.cluster.phi
)

names(res)
```

### 1. Visualise the dendrogram

```{r typical-plot}
# Plot to the current device with a phi cut and labels at that cut
cocktail_plot(
  x              = res,
  file           = NULL,       # RStudio Plots pane / current device
  phi_cut        = 0.25,
  label_clusters = TRUE,
  cex_species    = 0.9
)
```

### 2. Select parent clusters at a φ cut

```{r typical-clusters-at-cut}
phi_cut <- 0.25

parent_labels <- clusters_at_cut(
  x         = res,
  phi       = phi_cut,
  as_labels = TRUE
)

parent_labels
```

### 3. Diagnostic species for parent clusters

Topological species per parent cluster:

```{r typical-species-topo}
diag_sp_topo <- species_in_clusters(
  x      = res,
  labels = parent_labels
)

diag_sp_topo
```

With φ-based filtering and ranking (uses `Species.cluster.phi`):

```{r typical-species-phi}
diag_sp_phi <- species_in_clusters(
  x                   = res,
  labels              = parent_labels,
  species_cluster_phi = TRUE,
  min_phi             = 0.20
)

diag_sp_phi
```

### 4. φ-based distances between clusters

Compute a distance matrix between clusters based on species fidelity profiles.  
Here we include all nodes with `Cluster.height >= 0.1` to get a richer hierarchy for *hclust*:

```{r typical-phi-dist}
D <- cluster_phi_dist(
  x       = res,
  min_phi = 0.1          # keep nodes with merge phi >= 0.1
)

D

# Hierarchical clustering of clusters
hc_nodes <- hclust(D, method = "average")

plot(hc_nodes, main = "Cluster dendrogram (phi-based distance)", cex = 0.7)

grp_nodes <- cutree(hc_nodes, k = 2)
grp_nodes
table(grp_nodes)

# Build node groups as character labels ("c_1", "c_2", …) per group
node_groups <- split(names(grp_nodes), grp_nodes)
node_groups
```

### 5. Visualise grouped nodes on the Cocktail dendrogram

We can use `clusters = node_groups` to show union groups as coloured bands and label cluster IDs.
Within each group, if both an ancestor and a descendant node are present, only the **topmost** (ancestor) is used for labelling and band placement.

```{r typical-cocktail-groups}
cocktail_plot(
  x              = res,
  clusters       = node_groups,
  label_clusters = TRUE,
  cex_species    = 0.9
)
```

### 6. Assign plots (relevés) to groups

Use `assign_releves()` with one of the strategies:

- `"count"` – number of diagnostic species present.
- `"cover"` – summed relative cover of diagnostic species.
- `"phi_topo"` – sum of phi over topological species present.
- `"phi_cover_topo"` – sum of relative cover × phi over topological species.
- `"phi_cover"` – sum of relative cover × phi for species with phi ≥ `min_phi`.
- `"phi"` – sum of phi for species with phi ≥ `min_phi`.

Here we use `"phi_cover"` with the parent clusters at `phi_cut`:

```{r typical-assign}
assign_phi <- assign_releves(
  x              = res,
  vegmatrix      = vm,
  strategy       = "phi_cover",
  phi_cut        = phi_cut,
  min_phi        = 0.20,
  min_group_size = 1L
)

assign_phi
table(assign_phi)
```

The returned object is a named character vector (names = plot IDs). Each value is:

- a group label such as `"g_5"` for groups defined by a single node, or `"g_5_12"` for union groups of multiple non-nested nodes;
- `"+"` when there is an unresolved tie between groups;
- `"-"` for groups that were collapsed because they contain fewer plots than `min_group_size`;
- `NA` when no group wins for that plot.

For union groups that include both ancestors and descendants, only the **topmost** ancestor is kept within that group. In those cases, the label is just the ancestor ID (e.g. `"g_5"`), not a combined ID.

You can then attach these assignments to your plot header / metadata table.

---

### (Optional) Attach assignments to a header data frame

If you have a header table `hea` with a column `releve_number`, you can add multiple assignment strategies as new columns:

```{r attach-assignments, eval=FALSE}
library(dplyr)

# Example strategies you want as separate columns
strategies <- c("count", "cover", "phi_topo", "phi_cover_topo", "phi_cover")

hea2 <- hea

for (s in strategies) {
  rel_assigned <- assign_releves(
    x              = res,
    vegmatrix      = vm,
    strategy       = s,
    phi_cut        = 0.25,
    min_phi        = 0.20,
    min_group_size = 2
  )

  # Align by releve_number using the names of rel_assigned
  idx <- match(hea2$releve_number, as.integer(names(rel_assigned)))

  colname <- paste0("grp_", s)  # e.g. "grp_count", "grp_cover", ...

  hea2[[colname]] <- rel_assigned[idx]

  # Optional: turn "-" into NA instead of a literal dash
  # hea2[[colname]][hea2[[colname]] == "-"] <- NA_character_
}

dplyr::glimpse(hea2)
```

---

## Reference

See function help for details:

- `?cocktail_cluster` – build the Cocktail tree, optionally with species–cluster phi  
- `?cocktail_plot` – draw dendrograms (PDF/PNG or current device)  
- `?clusters_at_cut` – parent clusters at a phi cut  
- `?species_in_clusters` – diagnostic species per node or node union  
- `?cluster_phi_dist` – phi-based distances between clusters  
- `?assign_releves` – assign plots to groups using covers and phi

---

© 2025 Denys Vynokurov & Helge Bruelheide. Licensed under MIT.
